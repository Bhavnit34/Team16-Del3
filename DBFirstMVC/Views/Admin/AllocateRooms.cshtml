@model DBFirstMVC.Models.RequestInfo
@using System.Linq
@{

Layout = "~/Views/Shared/adminView.cshtml";

}
@{
    ViewBag.Title = "Alloacate Rooms";
    ViewBag.CurrentUserTitle = @ViewBag.CurrentUser;
}
<link rel="stylesheet" href="@Url.Content("/Content/jquery-ui.css")" type="text/css" />
<link rel="stylesheet" href="@Url.Content("/Content/BhavStyle.css")" type="text/css" />

<h2 style="float:right;"> <u>Request @Model.Request.RequestID</u></h2>



            <h2> Facilities</h2>
<ol>
@foreach (var item in Model.FacilityRequests) {

    <li>
            @Html.DisplayFor(modelItem => item.Facility.FacilityName) <!-- Display the facility name -->
        </li>
    
}
</ol>
               <h2>Rooms</h2>
<ol id="roomList">
@foreach(var item in Model.RequestToRooms){

       <li><a style="cursor:pointer;" onclick="showRoomInfo(this.text);">@Html.DisplayFor(modelItem => item.RoomRequest.RoomName)</a>  (@Html.DisplayFor(modelItem => item.RoomRequest.GroupSize) students)   
           @{
                if (item.RoomRequest.PriorityRoom == 1)
                {
                    <span><u>   Priority</u></span>
                }
                   
           }
           
       </li><!-- Display the room name -->
  

}
</ol>





      <h3>Group Size: @ViewBag.GroupSize</h3><br>
  


<div id="AddNewRoom">


  @if( !Model.RequestToRooms.Any() ){
      
      
      
      for (var i=0; i<3; i++)
      {
       <label>Room:</label><input type ="text"><label>Capacity:</label> <input type ="text"><br>

      
      
      
      
      }
      
  }
      
      


      else {
      
      
      foreach(var item in Model.RequestToRooms){

   <label>Room:</label>
       @Html.DisplayFor(modelItem => item.RoomRequest.RoomName)<br> <!-- Display the room name -->       
       @Html.EditorFor(modelItem => item.RoomRequest.RoomName)<br>
      <label>Capacity:</label>
      @Html.DisplayFor(modelItem => item.RoomRequest.GroupSize)<br> <!-- Display group size  -->       
       @Html.EditorFor(modelItem => item.RoomRequest.GroupSize)<br>
      
    
      }



      }
     
    </div>
         <div class="editor-field">
       <input type="button" id="Allocate" value="Allocate" />

       
         </div>
<table>
    <tr>
        <td>
            <h2>Information </h2>
        </td>
    </tr>
       <tr>
        <th>
            @Html.DisplayNameFor(model => model.Request.UserID)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.Module.Title)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.SessionType)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.SessionLength)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.DayID)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.PeriodID)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.PriorityRequest)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.AdhocRequest)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.SpecialRequirements)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.Semester)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.RoundID)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Request.Status)
        </th>
    
    </tr>
<tr>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.UserID)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.Module.Title)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.SessionType)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.SessionLength)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.DayID)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.PeriodID)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.PriorityRequest)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.AdhocRequest)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.SpecialRequirements)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.Semester)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.RoundID)
        </td>
        <td>
            @Html.DisplayFor(modelItem => modelItem.Request.Status)
        </td>
    </tr>
    

</table>



@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}
@section MyScripts{
    <script type="text/javascript">
      
        $(document).ready(function () {
          

            function showRoomInfo(room) {
                $.post('@Url.Action("ShowRoomInfo", "Request")',
                {
                    room: room
                },
                function (data, status) {
                });

             var url = '@Url.Action("DisplayRoomInfo","Request",new {id = "text"})';
             window.location.href = url.replace("text", "?id=" + room + "&caller=GetRequest");


         }

            $('#Allocate').click(function () {


                var checkArray = [];






                $("#AddNewRoom :text").each(function () {//getting values from text boxes
                    if ($(this).val() != "")
                        checkArray.push($(this).val());
                });
                function isEven(n) {
                    return (n % 2 == 0);
                }
                //check if every second element in the array is a number and if the lenght is even 
                var flag = 0;
                var size = 0;
                for (var z = 0; z < checkArray.length; z = z + 2) {
                    var temp = Number(checkArray[z + 1]);

                    if (typeof checkArray[z] == 'string' && !isNaN(temp) && isEven(checkArray.length))
                        //check capacity for numbers as well as they add up to group size 
                    {


                        size += temp;


                    }
                    else {


                        flag++;
                    }
                }

                if (flag == 0) {
                    if (size == '@ViewBag.GroupSize') {
                        alert(checkArray);
                        var strArr = checkArray.join("?");
                        $.post('@Url.Action("CheckRooms", "Admin")', { id: strArr }, function (data) {

                            if (data.length != 0) {
                                var showError = "";
                                for (var i = 0; i < data.length; i++) {

                                    showError += data[i] + "and";
                                }

                                alert("Room number :" + showError + "does not exist or you exceeded capacity for this rooms");

                            }
                                //****************check rooms 
                            else {
                                var reqId = '@Model.Request.RequestID';
                                // alert(reqId);
                                //alert(strArr);
                                // here u put one post which takes an array with rooms an chceck them if they are valid if not return array with wrong rooms and display them 
                                // if they exist then procced to to post

                                $.post('@Url.Action("UpdateAllocations", "Admin")', { id1: reqId, id2: strArr }, function (data) { //update allocations 

                                    //var test = data.rep alert(data);
                                    //JSON.stringify(data);
                                    /// alert(JSON.stringify(data).replace('__id__', reqId));
                                    // window.location.href = JSON.stringify(data).replace('__id__', reqId); 

                                    window.location.href = '/Admin/GetRequest/' + reqId;// redirect 



                                });//end UpdateAllocations

                            }

                        });//end CheckRooms
                    }

                    else {


                        alert("Please make sure the capacity for each room adds up to group size")
                    }

                }

                else {

                    alert("Please check your input")
                }
            });
        });
        
    </script>

}